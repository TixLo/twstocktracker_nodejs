<html>
<head>
    <meta charset="UTF-8">
    <title>監控中心</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker3.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/js/common.js"></script>
    <link rel="stylesheet" href="/css/techanStyle.css?v=13">
    <% include banner %>
</head>
<body>
    <div class="modal" id="waitingForApply" tabindex="-1" role="dialog" aria-labelledby="waitingAddStockLabel">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="loader"></div>
                    <div clas="loader-txt">
                        <p>正在套用您的設定....</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirmErroorModal" tabindex="-1" role="dialog" aria-labelledby="confirmErroorModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmErroorModalLabel">通知</h5>
                </div>
                <div class="modal-body">
                    <label id="errMsg"></label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-dark" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="card">
        <div class="card-header">參數設定</div>
        <div class="card-body">
            <% include tradingCondition %>
        </div>
    </div>
    <div class="card">
        <div class="card-header">觀察中的股票</div>
        <div class="card-body">
            <% include observedStocks %>
        </div>
    </div>
    <div class="card">
        <div class="card-header">股票線圖</div>
        <div class="card-body">
            <% include candlestick %>
        </div>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="/js/techan.js"></script>
<script src="/js/stocktool.js?v=46"></script>
<script>
var socket;
var stockDataUrl = '';

function showPopup(msg) {
    $('#errMsg').text(msg);
    $('#confirmErroorModal').modal('show');
}

$("#editStock").click(function() {
    window.location.href = "/stock/warehouse";
});

var updateMonitorStocks = function() {
    $('#monitorStocks').bootstrapTable('refresh', {
        url: '/stock/monitorStocks'
    });
}

var showApplyLoading = function() {
    $("#waitingForApply").modal({
      backdrop: "static", //remove ability to close modal with click
      keyboard: false, //remove option to close with keyboard
      show: true //Display loader!
    });
}

var hideApplyLoading = function() {
    $('#waitingForApply').modal('hide');
}

var initGraph = function() {
    if (stockDataUrl == '')
        return;

    //d3.select("svg").remove();
    removeStockGraph();
    let opt = {
        ma5: $('#ma5Checkbox').prop('checked'),
        ma10: $('#ma10Checkbox').prop('checked'),
        ma20: $('#ma20Checkbox').prop('checked'),
        ma40: $('#ma40Checkbox').prop('checked'),
        ma60: $('#ma60Checkbox').prop('checked'),
    }

    initStockGraph(stockDataUrl, opt);
}

$('#applyStockConfig').click(function() {
    if (stockDataUrl == '')
        return;

    showApplyLoading();
    initGraph();
    setTimeout(function() {
        hideApplyLoading();
    },1000);
});

$('#applySelectStock').click(function() {
    let focusStockId = undefined;
    $('#monitorStocks > tbody  > tr').each(function(){
        if ($(this).attr('class') != undefined && $(this).attr('class').indexOf('selected') >= 0) {
            focusStockId = $(this).find('td').slice(2,3).text();
        }
    });

    if (focusStockId == undefined) {
        showPopup('請選擇一檔要觀察的股票');
        return;
    }
    console.log(focusStockId);

    let fixedDeltaMS = 0;
    if ($("#oneMonth").is(":checked")) {
        fixedDeltaMS = 30 * 24 * 60 * 60 * 1000;
    }
    if ($("#threeMonth").is(":checked")) {
        fixedDeltaMS = 3 * 30 * 24 * 60 * 60 * 1000;
    }
    if ($("#sixMonth").is(":checked")) {
        fixedDeltaMS = 6 * 30 * 24 * 60 * 60 * 1000;
    }
    if ($("#oneYear").is(":checked")) {
        fixedDeltaMS = 12 * 30 * 24 * 60 * 60 * 1000;
    }
    if ($("#twoYear").is(":checked")) {
        fixedDeltaMS = 2 * 12 * 30 * 24 * 60 * 60 * 1000;
    }
    if ($("#threeYear").is(":checked")) {
        fixedDeltaMS = 3 * 12 * 30 * 24 * 60 * 60 * 1000;
    }

    let startDate = $('#startDate').val();
    let endDate = $('#endDate').val();
    let startms = 0;
    let endms = 0;
    let data = {};
    if (startDate != '' && endDate != '') {
        startms = new Date(startDate).getTime();
        endms = new Date(endDate).getTime();
        if (startms >= endms) {
            showPopup('"開始日期"要小於"結束日期"');
            return;
        }
        data = {
            stock: focusStockId,
            startTime: startDate,
            endTime: endDate
        };
    }
    else if (fixedDeltaMS > 0) {
        let convertToDate = function(ms) {
            let d = new Date(ms);
            let yyyy = d.getFullYear();
            let mm = d.getMonth() + 1;
            let dd = d.getDate();
            let d2 = mm + '/' + dd + '/' + yyyy;
            return d2; 
        }
        endms = new Date().getTime();
        startms = endms - fixedDeltaMS;
        
        data = {
            stock: focusStockId,
            startTime: convertToDate(startms),
            endTime: convertToDate(endms)
        };
    }
    else {
        data = {
            stock: focusStockId
        };
    }

    console.log(data);

    showApplyLoading();
    $.ajax({
        type: 'POST',
        url: '/stock/genstock',
        data: data,
        success: function(res){
            console.log(res);
            if (res.dataUrl != undefined && res.dataUrl != '') {
                stockDataUrl = res.dataUrl;
                initGraph();
            }
        }
    }).always(function(){
        hideApplyLoading();
    });

});

$('#monitorStocks').on('dbl-click-row.bs.table', function (row, $element, field) {
    console.log('dbl-click');
    console.log(row);
})


$(function() {
    updateMonitorStocks();

    registryOnlineCB(updateOnline);
    socket = initSocketIO();

    $('.datepicker').datepicker();
});
</script>
</html>
